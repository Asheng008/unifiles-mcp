# 解释代码/文字/文件

解释用户选择的代码、文字或文件内容，提供清晰、详细的中文说明。

## 目标

- 分析并解释用户选择的代码片段、文字内容、文件或终端输出
- 提供清晰、结构化的中文解释
- 根据内容类型（代码、文档、配置、终端输出等）采用相应的解释方式
- 帮助用户理解代码逻辑、设计意图、配置含义、命令/错误输出等

## 处理流程

### 1. 识别输入类型

根据用户选择的内容，判断类型：
- **代码片段**：Python、配置文件、Markdown 等代码
- **文档文字**：README、技术文档、注释等
- **文件路径**：用户选择或提及的文件
- **终端输出**：命令执行结果、错误日志、测试输出、构建/安装输出等（来自终端、控制台或 IDE 的终端面板）
- **混合内容**：代码 + 注释、多文件、命令与输出组合等

### 2. 分析内容

根据内容类型进行相应分析：

**代码分析**：
- 功能说明：这段代码做什么
- 逻辑流程：代码执行流程
- 关键概念：使用的技术、库、模式
- 参数/返回值：函数签名、类型注解
- 依赖关系：与其他代码/模块的关系
- 潜在问题：可能的错误、边界情况

**文档分析**：
- 主要内容：文档的核心信息
- 结构组织：章节、层次结构
- 关键要点：重要概念、规则、约定
- 使用场景：适用情况、示例

**配置文件分析**：
- 配置项说明：每个配置的含义
- 默认值：默认设置及其影响
- 依赖关系：配置之间的关联
- 最佳实践：推荐的配置方式

**终端输出分析**：
- 输出类型：正常输出、错误信息、警告、测试结果、构建/安装日志等
- 结构解析：命令提示符、标准输出、标准错误、退出码（如有）
- 关键信息：成功/失败标志、错误堆栈、行号、路径、建议或 hint
- 原因推断：可能触发该输出的命令或操作、环境或配置因素
- 解决建议：若是错误/警告，给出排查步骤或修复方向

### 2.1 查询工具使用（当遇到不确定内容时）

**当遇到以下情况时，必须使用查询工具**：
- 不熟悉的库、框架、API 用法
- 不确定的配置项含义
- 需要最新文档或最佳实践
- 代码中使用了不常见的模式或技术
- 需要验证某个概念或实现方式

**工具使用优先级**：

1. **Context7（MCP 工具）** - 优先使用
   - **适用场景**：查询库的官方文档、API 用法、代码示例
   - **使用方法**：
     - 先使用 `mcp_context7_resolve-library-id` 解析库名称
     - 再使用 `mcp_context7_query-docs` 查询具体文档
   - **示例**：
     - 代码中使用了 `pandas.ExcelWriter` → 查询 pandas 官方文档
     - 配置中有 `[tool.mypy]` → 查询 mypy 配置文档
     - 代码使用了 `pathlib.Path` → 查询 Python 标准库文档

2. **联网搜索（Web Search）** - 备选方案
   - **适用场景**：
     - Context7 无法找到相关文档
     - 需要查找最新信息、博客文章、Stack Overflow 解答
     - 查询特定错误信息或解决方案
   - **使用方法**：使用 `web_search` 工具
   - **示例**：
     - 查询 "pandas ExcelWriter 多工作表写入最佳实践"
     - 查询 "mypy python_version 3.10 配置说明"
     - 查询特定错误信息或警告

3. **RefTools（MCP 工具）** - 补充查询
   - **适用场景**：搜索通用技术文档、GitHub 文档、PDF 文档
   - **使用方法**：使用 `mcp_RefTools_ref_search_documentation` 和 `mcp_RefTools_ref_read_url`

**查询后的处理**：
- 将查询结果整合到解释中
- 明确标注信息来源（如"根据 pandas 官方文档..."）
- 如果查询结果与代码中的用法不一致，说明可能的问题
- 如果查询无结果，说明情况并基于现有知识提供解释

### 3. 提供解释

**解释格式**：

1. **概述**：一句话总结内容的核心
2. **详细说明**：
   - 代码：逐行或逐块解释
   - 文档：按章节或要点说明
   - 配置：逐项说明
   - **终端输出**：输出类型、各部分含义、错误/警告解读、退出码含义
3. **关键点**：重要概念、设计决策、注意事项
4. **相关上下文**：与项目其他部分的关联
5. **示例/用法**（如适用）：如何使用、示例代码；若为错误输出，补充**排查或修复建议**

### 4. 特殊处理

**代码解释时**：
- 识别设计模式（如适用）
- 说明类型注解的含义
- 解释异常处理逻辑
- 指出性能考虑（如适用）
- 说明测试覆盖情况（如可获取）

**文档解释时**：
- 提取关键信息
- 说明文档的目的和受众
- 指出与其他文档的关系

**文件解释时**：
- 先读取文件内容
- 根据文件类型（.py, .md, .toml 等）采用相应分析方式
- 说明文件在项目中的作用

**终端输出解释时**：
- 区分 stdout / stderr、提示符与正文
- 若有错误/警告，重点解释含义、触发原因和解决思路
- 若有测试/构建输出，说明通过与否、覆盖率或关键指标
- 若输出包含命令或路径，说明其作用及与项目的关联
- 对不认识的错误信息，使用 Context7 或联网搜索查文档/解决方案后再解释

## 输出要求

- **语言**：使用中文，专业但易懂
- **结构**：使用清晰的标题、列表、代码块
- **深度**：根据内容复杂度提供适当深度的解释
- **准确性**：确保解释准确，不猜测不确定的内容
- **上下文**：结合项目整体情况（如适用）

## 示例输出格式

### 代码解释示例

```markdown
## 概述
这是一个用于读取 Excel 文件的函数，支持指定工作表名称或索引。

## 详细说明
- **函数签名**：`read_excel(file_path: str, sheet_name: str | int | None = None) -> pd.DataFrame`
- **参数**：
  - `file_path`: Excel 文件路径
  - `sheet_name`: 可选，工作表名称（字符串）、索引（整数）或 None（读取第一个工作表）
- **返回值**：pandas DataFrame 对象

## 执行流程
1. 检查文件是否存在（使用 pathlib.Path）
2. 调用 pandas.read_excel() 读取文件
3. 处理可能的异常（FileNotFoundError, ValueError）
4. 返回 DataFrame

## 关键点
- 使用 Python 3.10+ 的联合类型语法（`str | int | None`）
- 完整的错误处理，提供清晰的错误信息
- 支持多种工作表指定方式，灵活易用
```

### 文档解释示例

```markdown
## 概述
这是项目的技术需求文档，定义了 MVP 阶段的功能范围和技术架构。

## 主要内容
- **支持的文件类型**：Excel、PDF、Word、SQLite
- **技术栈**：Python 3.9+，pandas、openpyxl、pypdf、python-docx
- **API 设计**：统一的接口风格，完整的类型注解

## 关键要点
- MVP 阶段明确限制：PDF 表格提取仅支持基础表格
- 所有函数都有完整的类型提示和文档字符串
- 项目结构采用 src 布局，便于打包分发
```

### 终端输出解释示例

```markdown
## 概述
这是运行 pytest 后的终端输出，显示测试通过及覆盖率结果。

## 输出类型与结构
- **类型**：测试运行结果（标准输出）
- **结构**：平台信息 → 收集用例 → 用例执行 → 覆盖率报告

## 各部分含义
- **platform / Python / pytest**：运行环境与版本
- **collected N items**：收集到的测试用例数量
- **test_xxx PASSED**：单个用例通过
- **tests coverage**：覆盖率统计（Stmts/Miss/Cover、Missing 行）
- **N passed**：全部通过

## 关键点
- 所有测试通过，无失败或跳过
- 覆盖率百分比与缺失行（Missing）可作为后续补充测试的参考

## 若为错误输出时的补充
- **错误含义**：用一句话说明该错误在说什么
- **可能原因**：环境、依赖、路径、权限、配置等
- **排查或修复建议**：具体步骤或可搜索的关键词
```

## 注意事项

- 如果内容不完整或上下文不足，说明需要更多信息
- **如果遇到不确定的内容，必须先使用查询工具（Context7 或联网搜索）获取准确信息，不要猜测**
- 对于复杂内容，可以分层次解释（整体 → 细节）
- 结合项目的 AGENTS.md、TRD.md 等文档提供上下文（如适用）
- 查询工具使用后，在解释中标注信息来源，提高可信度

## 工具使用示例

### 示例 1：解释使用了不熟悉库的代码

**场景**：代码中使用了 `pd.ExcelWriter(engine="openpyxl")`

**处理流程**：
1. 识别到使用了 pandas 的 ExcelWriter 和 openpyxl 引擎
2. 如果不确定 `engine="openpyxl"` 的含义，调用 Context7：
   ```
   - resolve-library-id: pandas
   - query-docs: "ExcelWriter engine parameter openpyxl usage"
   ```
3. 将查询结果整合到解释中：
   ```markdown
   ## 关键点
   - 使用 `engine="openpyxl"` 指定 Excel 引擎
   - 根据 pandas 官方文档，openpyxl 引擎支持 .xlsx 格式...
   ```

### 示例 2：解释配置文件中的不熟悉配置项

**场景**：`pyproject.toml` 中有 `[tool.mypy]` 配置

**处理流程**：
1. 识别到 mypy 类型检查配置
2. 如果不确定某个配置项的含义，调用 Context7：
   ```
   - resolve-library-id: mypy
   - query-docs: "mypy python_version configuration option"
   ```
3. 或使用联网搜索：
   ```
   - web_search: "mypy python_version pyproject.toml configuration"
   ```
4. 将查询结果整合到解释中

### 示例 3：解释使用了设计模式的代码

**场景**：代码中使用了上下文管理器模式

**处理流程**：
1. 识别到使用了 `with` 语句和上下文管理器
2. 如果需要更详细的说明，可以查询：
   ```
   - web_search: "Python context manager pattern best practices"
   ```
3. 结合查询结果和代码实际情况提供解释
